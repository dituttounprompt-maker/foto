<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Listino Prodotti – Vista compatta</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;padding:0;background:#fff;color:#111}
  header{background:#0ea5e9;color:#fff;padding:12px 16px;font-weight:600}
  .toolbar{display:flex;gap:12px;align-items:center;justify-content:space-between;margin:12px 16px;flex-wrap:wrap}
  .toolbar select{padding:8px 10px;border:1px solid #e5e7eb;border-radius:8px;background:#fff}
  .category{margin:20px 16px 8px;font-weight:700;font-size:18px;border-bottom:1px solid #e5e7eb;padding-bottom:4px}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px;padding:0 16px}
  .card{border:1px solid #e5e7eb;border-radius:10px;padding:10px;background:#fafafa;box-shadow:0 0 2px rgba(0,0,0,0.05)}
  .name{font-weight:600;font-size:13px;line-height:1.2;margin-bottom:6px}
  .desc{font-size:12px;color:#6b7280;height:32px;overflow:hidden}
  .price{margin-top:8px;font-weight:600;font-size:13px;text-align:right;color:#0ea5e9}
  .warn{background:#fff3cd;border:1px solid #ffe69c;color:#856404;padding:10px;border-radius:8px;margin:12px 16px}
</style>
</head>
<body>

<header>Listino Prodotti – Vista compatta</header>

<div class="toolbar">
  <div>
    <label style="font-size:12px;color:#6b7280">Vista:</label>
    <select id="mode">
      <option value="bycat" selected>Raggruppa per categoria</option>
      <option value="alpha">Ordine alfabetico</option>
    </select>
  </div>
  <div>
    <label style="font-size:12px;color:#6b7280">Ordina:</label>
    <select id="order">
      <option value="name" selected>Nome A→Z</option>
      <option value="price">Prezzo crescente</option>
    </select>
  </div>
</div>

<div id="warn" class="warn" style="display:none">Nessun dato trovato. Controlla che <code>prodotti-generati-da-excel.js</code> definisca <code>const PRODUCTS = [...];</code></div>
<div id="app"></div>

<!-- Carica i prodotti generati -->
<script src="prodotti-generati-da-excel.js"></script>

<script>
(function(){
  if(typeof PRODUCTS === "undefined" || !Array.isArray(PRODUCTS)){
    document.getElementById('warn').style.display = 'block';
    return;
  }

  const fmtEUR = n => typeof n==="number"&&!isNaN(n)
    ? new Intl.NumberFormat('it-IT',{style:'currency',currency:'EUR'}).format(n)
    : "";

  function sortItems(items, key){
    const arr=[...items];
    if(key==='price'){
      arr.sort((a,b)=>(a.price??Infinity)-(b.price??Infinity)||String(a.name).localeCompare(String(b.name),'it',{sensitivity:'base'}));
    }else{
      arr.sort((a,b)=>String(a.name).localeCompare(String(b),'it',{sensitivity:'base'}));
    }
    return arr;
  }
  function groupByCategory(items){
    const map=new Map();
    for(const it of items){
      const cat=(it.categoria&&String(it.categoria).trim())||'Generale';
      if(!map.has(cat)) map.set(cat,[]);
      map.get(cat).push(it);
    }
    return map;
  }
  function cardHTML(it){
    const name=it.name||it.articolo||it.id||"";
    const desc=it.shortDesc||"";
    const price=typeof it.price==='number'?fmtEUR(it.price):"";
    return `<div class="card">
      <div class="name">${name}</div>
      <div class="desc">${desc}</div>
      <div class="price">${price}</div>
    </div>`;
  }
  function render(){
    const mode=document.getElementById('mode').value;
    const order=document.getElementById('order').value;
    const base=sortItems(PRODUCTS,order);
    let html="";
    if(mode==='bycat'){
      const grouped=groupByCategory(base);
      const cats=[...grouped.keys()].sort((a,b)=>String(a).localeCompare(String(b),'it',{sensitivity:'base'}));
      for(const cat of cats){
        const list=sortItems(grouped.get(cat),order);
        html+=`<div class="category">${cat}</div><div class="grid">`+list.map(cardHTML).join('')+`</div>`;
      }
    }else{
      html=`<div class="grid">`+base.map(cardHTML).join('')+`</div>`;
    }
    document.getElementById('app').innerHTML=html;
  }
  document.getElementById('mode').addEventListener('change',render);
  document.getElementById('order').addEventListener('change',render);
  render();
})();
</script>
</body>
</html>
